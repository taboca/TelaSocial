<html>
<head>
	<script type="text/javascript" charset="utf-8" src='../vendor/jquery.js'> 
	</script>
<script>

function longPoll_feed () {
	//make another request

	$.ajax({
			cache: false,
			dataType: 'json',
			type: "GET",
			url: "http://127.0.0.1/real_time_feed",
			error: function (e) {
				//don't flood the servers on error, wait 10 seconds before retrying
				alert(e.status)
				setTimeout(longPoll_feed, 10*1000);
			},
			success: function (json) {
				display_event(json);
				
				//if everything went well, begin another request immediately
				//the server will take a long time to respond
				//how long? well, it will wait until there is another message
				//and then it will return it to us and close the connection.
				//since the connection is closed when we get data, we longPoll again
				longPoll_feed();
			}
		});
}

function display_event(json){
	$('#feed_holder').prepend('<hr />');
	

	switch(json[0].type){
		case 'message':
alert(JSON.stringify(json));
			$('#feed_holder').prepend('<p>'+json[0].content+'</p>');
		break;
		
		case 'youtube':
			video_id = json[0].content.url;
			video_id = video_id.substring(video_id.indexOf('?v=')+3,video_id.length);
		
			$('#feed_holder').prepend('<object width="575" height="385"><param name="movie" value="http://www.youtube.com/v/'+video_id+'&amp;hl=en_US&amp;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/'+video_id+'&amp;hl=en_US&amp;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="575" height="385"></embed></object>');
		break;
	}
}

$(document).ready(function() {
	//begin listening for updates right away
	longPoll_feed();
});

</script>


</head>
<body>

			<div id="feed_holder">
				<p>Real-time called events will be displayed here.</p>
			</div>
			
</body>
</html>

